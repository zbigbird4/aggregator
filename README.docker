# Aggregator Docker å¿«é€Ÿå‚è€ƒ

## å¿«é€Ÿå¼€å§‹ (5åˆ†é’Ÿ)

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/wzdnzd/aggregator.git
cd aggregator

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .envï¼Œå¡«å…¥ä½ çš„GitHub Tokenå’ŒGist ID

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f aggregator

# 5. æŸ¥çœ‹ç»“æœ
ls output/
cat output/clash.yaml
```

---

## å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

### å®¹å™¨ç®¡ç†

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `docker-compose build` | æ„å»ºé•œåƒï¼ˆé¦–æ¬¡æˆ–æ›´æ–°ä»£ç åï¼‰ |
| `docker-compose up -d` | åå°å¯åŠ¨å®¹å™¨ |
| `docker-compose down` | åœæ­¢å¹¶åˆ é™¤å®¹å™¨ |
| `docker-compose restart` | é‡å¯å®¹å™¨ |
| `docker-compose stop` | åœæ­¢å®¹å™¨ |
| `docker-compose ps` | æŸ¥çœ‹å®¹å™¨çŠ¶æ€ |

### æ—¥å¿—æŸ¥çœ‹

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `docker-compose logs aggregator` | æŸ¥çœ‹æ‰€æœ‰æ—¥å¿— |
| `docker-compose logs -f aggregator` | å®æ—¶æŸ¥çœ‹æ—¥å¿— |
| `docker-compose logs -n 100 aggregator` | æŸ¥çœ‹æœ€å100è¡Œ |
| `docker-compose logs aggregator \| grep ERROR` | åªçœ‹é”™è¯¯ |

### æ•°æ®è®¿é—®

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `docker-compose exec aggregator bash` | è¿›å…¥å®¹å™¨ |
| `docker cp aggregator:/aggregator/output/clash.yaml ./` | å¤åˆ¶æ–‡ä»¶ |
| `docker-compose exec aggregator ls -la output/` | æŸ¥çœ‹å®¹å™¨å†…æ–‡ä»¶ |

### è°ƒè¯•å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `docker stats aggregator` | å®æ—¶èµ„æºä½¿ç”¨ |
| `docker-compose exec aggregator python -c "import sys; print(sys.version)"` | æ£€æŸ¥Pythonç‰ˆæœ¬ |
| `docker-compose exec aggregator pip list` | æŸ¥çœ‹å·²å®‰è£…åŒ… |
| `docker-compose exec aggregator env \| grep AGGREGATOR` | æŸ¥çœ‹ç¯å¢ƒå˜é‡ |

---

## ç¯å¢ƒå˜é‡é€ŸæŸ¥

### æœ€å°å¿…éœ€é…ç½®

```env
# ä¸é…ç½®åˆ™æœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼Œæ— æ³•ä¸Šä¼ åˆ°Gist
# GIST_PAT=your_github_token
# GIST_LINK=username/gist-id
```

### å¸¸ç”¨é…ç½®

```env
# æ—¥å¿—çº§åˆ«
AGGREGATOR_LOG_LEVEL=INFO          # DEBUG, INFO, WARNING, ERROR

# ä»£ç†æµ‹è¯•å‚æ•°
CONCURRENT_LIMIT=10                # å¹¶å‘æ•° (æ ¹æ®æœåŠ¡å™¨è°ƒæ•´)
MAX_LATENCY=5000                   # æœ€å¤§å»¶è¿Ÿ(ms)

# è®¡åˆ’ä»»åŠ¡
CRON_SCHEDULE=0 */6 * * *          # Cronè¡¨è¾¾å¼
AUTO_RUN_ON_START=true             # å¯åŠ¨æ—¶è¿è¡Œ

# å­˜å‚¨ç±»å‹
STORAGE_TYPE=file                  # file, redis, upstash
```

### å®Œæ•´é…ç½®

è¯¦è§ `.env.example` æ–‡ä»¶ï¼ˆåŒ…å«æ‰€æœ‰æ”¯æŒçš„ç¯å¢ƒå˜é‡åŠè¯´æ˜ï¼‰

---

## ä¸æ ‡å‡†éƒ¨ç½²çš„å¯¹æ¯”

| åŠŸèƒ½ | Docker | æ ‡å‡†éƒ¨ç½² |
|------|--------|---------|
| å®‰è£…éš¾åº¦ | â­ æç®€ | â­â­â­ å¤æ‚ |
| ç¯å¢ƒéš”ç¦» | âœ… å®Œå…¨éš”ç¦» | âŒ ä¾èµ–ç³»ç»Ÿ |
| å¯åŠ¨é€Ÿåº¦ | â­â­â­ å¿«é€Ÿ | â­ è¾ƒæ…¢ |
| é…ç½®ç®¡ç† | âœ… ç»Ÿä¸€ .env | âŒ å¤šæ–‡ä»¶ |
| æ›´æ–°å‡çº§ | âœ… ä¸€è¡Œå‘½ä»¤ | âŒ æ‰‹åŠ¨å¤„ç† |
| å¤šå®ä¾‹ | âœ… è½»æ¾éƒ¨ç½² | âŒ å¤æ‚é…ç½® |
| æ•°æ®æŒä¹…åŒ– | âœ… Volumes | âŒ æ–‡ä»¶ç³»ç»Ÿ |
| è·¨å¹³å° | âœ… Linux/Mac/Win | âš ï¸ ä¾èµ–ç³»ç»Ÿ |

---

## å¸¸è§é—®é¢˜

### å®¹å™¨æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹é”™è¯¯
docker-compose logs aggregator

# é‡å»ºé•œåƒ
docker-compose build --no-cache

# æ¸…ç†æ‰€æœ‰æ•°æ®é‡æ–°å¼€å§‹
docker-compose down -v
```

### ä»£ç†æµ‹è¯•å¤±è´¥
```bash
# æ£€æŸ¥ç½‘ç»œ
docker-compose exec aggregator ping 8.8.8.8

# å¢åŠ è¶…æ—¶æ—¶é—´
# ç¼–è¾‘ .env
MAX_LATENCY=10000
HTTP_TIMEOUT=15

# é™ä½å¹¶å‘
CONCURRENT_LIMIT=5
```

### ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
du -sh ./output ./data ./logs

# æ¸…ç†æ—§æ•°æ®
docker-compose exec aggregator find /aggregator/data -mtime +7 -delete

# æ¸…ç†Docker
docker system prune -a
```

### Gistä¸Šä¼ å¤±è´¥
```bash
# éªŒè¯token
echo $GIST_PAT

# æ£€æŸ¥Gist ID
curl https://api.github.com/gists/your-gist-id

# é‡æ–°ç”Ÿæˆtoken: https://github.com/settings/tokens
```

---

## æ–‡ä»¶ç»“æ„

```
project/
â”œâ”€â”€ Dockerfile              # Dockeré•œåƒå®šä¹‰
â”œâ”€â”€ docker-compose.yml      # æœåŠ¡ç¼–æ’é…ç½®
â”œâ”€â”€ .env.example           # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ .env                   # å®é™…é…ç½®ï¼ˆä¸æäº¤ï¼‰
â”œâ”€â”€ DEPLOYMENT.md          # è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
â”œâ”€â”€ README.docker          # æœ¬æ–‡ä»¶
â”œâ”€â”€ requirements.txt       # Pythonä¾èµ–
â”œâ”€â”€ subscribe/             # ä¸»ç¨‹åº
â”œâ”€â”€ output/               # è¾“å‡ºç›®å½•
â”œâ”€â”€ data/                 # ç¼“å­˜æ•°æ®
â””â”€â”€ logs/                 # æ—¥å¿—ç›®å½•
```

---

## æ€§èƒ½è°ƒä¼˜

### ä½ç«¯æœºå™¨ (1æ ¸2GB)
```env
CONCURRENT_LIMIT=5
TEST_COUNT=1
MAX_LATENCY=8000
```

### ä¸­ç«¯æœºå™¨ (2æ ¸4GB)
```env
CONCURRENT_LIMIT=10
TEST_COUNT=2
MAX_LATENCY=5000
```

### é«˜ç«¯æœºå™¨ (4æ ¸8GB)
```env
CONCURRENT_LIMIT=30
TEST_COUNT=2
MAX_LATENCY=3000
STORAGE_TYPE=redis
```

---

## æ›´æ–°é•œåƒ

```bash
# æ–¹æ³•1: ä»Dockerfileæ„å»º
docker-compose build --no-cache

# æ–¹æ³•2: æ‹‰å–é¢„æ„å»ºé•œåƒ
docker pull wzdnzd/aggregator:latest
docker-compose pull

# æŸ¥çœ‹é•œåƒ
docker images | grep aggregator

# æ¸…ç†æ—§é•œåƒ
docker image prune
```

---

## è·å–å¸®åŠ©

- ğŸ“š è¯¦ç»†æ–‡æ¡£: [DEPLOYMENT.md](./DEPLOYMENT.md)
- ğŸ“– é¡¹ç›®æ–‡æ¡£: [README.md](./README.md)
- ğŸ› æŠ¥å‘Šé—®é¢˜: https://github.com/wzdnzd/aggregator/issues
- ğŸ’¬ è®¨è®º: https://github.com/wzdnzd/aggregator/discussions

---

## å®Œæ•´å·¥ä½œæµç¤ºä¾‹

### åŸºç¡€åœºæ™¯
```bash
# åˆæ¬¡è®¾ç½®
git clone https://github.com/wzdnzd/aggregator.git && cd aggregator
cp .env.example .env
# ç¼–è¾‘ .env
docker-compose build
docker-compose up -d
docker-compose logs -f

# æ—¥å¸¸ä½¿ç”¨
docker-compose ps           # æ£€æŸ¥çŠ¶æ€
docker-compose logs         # æŸ¥çœ‹æ—¥å¿—
ls output/                 # æŸ¥çœ‹è¾“å‡º

# å‡çº§ç‰ˆæœ¬
git pull
docker-compose build --no-cache
docker-compose restart
```

### é«˜çº§åœºæ™¯
```bash
# å¯ç”¨Redisç¼“å­˜
# ç¼–è¾‘ .env
STORAGE_TYPE=redis

# ä¿®æ”¹docker-compose.ymlä»¥å¯ç”¨RedisæœåŠ¡
# å¯åŠ¨
docker-compose up -d

# ç›‘æ§
docker stats
docker-compose exec redis redis-cli info memory

# å¤‡ä»½
tar -czf backup-$(date +%Y%m%d).tar.gz output/ data/
```

---

æœ€åä¿®æ”¹: 2024å¹´
